/*
    jqTouch
    Created by David Kaneda <http://www.davidkaneda.com>
    Documentation and issue tracking on GitHub <http://wiki.github.com/senchalabs/jQTouch/>

    Special thanks to Jonathan Stark <http://jonathanstark.com/>
    and pinch/zoom <http://www.pinchzoom.com/>

    (c) 2010 by jQTouch project members.
    See LICENSE.txt for license.

    $Revision: 161 $
    $Date: Wed Jan 19 23:43:35 EST 2011 $
    $LastChangedBy: jonathanstark $
*/

(function(a){a.jQTouch=function(b){function Q(b){function r(){var a=event.changedTouches[0]||null;l=a.pageX-i,m=a.pageY-j,n=(new Date).getTime()-d}function q(a){r();var b=Math.abs(l),d=Math.abs(m),g;b>d&&b>35&&n<1e3&&(l<0?g="left":g="right",c.unbind("touchmove",q).unbind("touchend",p).unbind("touchcancel",o),c.trigger("swipe",{direction:g,deltaX:l,deltaY:m})),c.unselect(),clearTimeout(e),(b>h.moveThreshold||d>h.moveThreshold)&&clearTimeout(f)}function p(a){u(),c.unbind("touchend",p).unbind("touchcancel",o),clearTimeout(e),clearTimeout(f),Math.abs(l)<h.moveThreshold&&Math.abs(m)<h.moveThreshold&&n<h.pressDelay?c.trigger("tap",a):c.unselect()}function o(a){u(),clearTimeout(e),c.unselect(),c.unbind("touchmove",q).unbind("touchend",p).unbind("touchcancel",o)}u();if(!k){u("TouchStart handler aborted because tap is not ready"),b.preventDefault();return!1}var c=a(b.target);if(!c.length)u("Could not find target of touchstart event.");else{var d=(new Date).getTime(),e=null,f=null,g,i,j,l=0,m=0,n=0;event.changedTouches&&event.changedTouches.length&&(g=event.changedTouches[0],i=g.pageX,j=g.pageY),c.bind("touchmove",q).bind("touchend",p).bind("touchcancel",o),e=setTimeout(function(){c.makeActive()},h.hoverDelay),f=setTimeout(function(){c.unbind("touchmove",q).unbind("touchend",p).unbind("touchcancel",o),c.unselect(),clearTimeout(e),c.trigger("press")},h.pressDelay)}}function P(b){u();if(!k){u("Tap is not ready");return!1}var c=a(b.target);if(!c.is(n.join(", ")))var c=a(b.target).closest(n.join(", "));if(!c.length||!c.attr("href")){u("Could not find a link related to tapped element");return!1}var d=c.attr("target"),e=c.attr("hash"),f=null;if(c.isExternalLink()){c.unselect();return!0}if(c.is(h.backSelector))A(e);else if(c.is(h.submitSelector))K(c);else{if(d==="_webapp"){window.location=c.attr("href");return!1}if(c.attr("href")==="#"){c.unselect();return!0}for(var g=0,i=r.length;g<i;g++)if(c.is(r[g].selector)){f=r[g];break}f||(console.warn("Animation could not be found. Using slideleft."),f="slideleft");if(e&&e!=="#"){c.addClass("active"),B(a(e).data("referrer",c),f,a(this).hasClass("reverse"));return!1}c.addClass("loading active"),I(c.attr("href"),{animation:f,callback:function(){c.removeClass("loading"),setTimeout(a.fn.unselect,250,c)},$referrer:c});return!1}}function O(){u();var a,b,c,d,e;a=document.getElementsByTagName("head")[0],b=document.body,c=document.createElement("style"),c.textContent="@media (transform-3d),(-o-transform-3d),(-moz-transform-3d),(-ms-transform-3d),(-webkit-transform-3d),(modernizr){#jqtTestFor3dSupport{height:3px}}",d=document.createElement("div"),d.id="jqtTestFor3dSupport",a.appendChild(c),b.appendChild(d),e=d.offsetHeight===3,c.parentNode.removeChild(c),d.parentNode.removeChild(d);return e}function N(){u();if(!h.useFastTouch)return!1;return typeof TouchEvent!="undefined"?window.navigator.userAgent.indexOf("Mobile")>-1?!0:!1:!1}function M(){u();return typeof WebKitCSSMatrix!="undefined"}function L(){u();return typeof WebKitAnimationEvent!="undefined"}function K(b){u();var c=b.closest("form");if(c.length===0)u("No parent form found");else{u("About to submit parent form");var d=a.Event("submit");d.preventDefault(),c.trigger(d);return!1}return!0}function J(b,c){u(),a(":focus").blur(),b.preventDefault();var d=typeof b==="string"?a(b).eq(0):b.target?a(b.target):a(b);u(d.attr("action"));if(d.length&&d.is(h.formSelector)&&d.attr("action")){I(d.attr("action"),{data:d.serialize(),method:d.attr("method")||"POST",animation:r[0]||null,callback:c});return!1}return!1}function I(b,c){u();var d={data:null,method:"GET",animation:null,callback:null,$referrer:null},e=a.extend({},d,c);b!="#"?a.ajax({url:b,data:e.data,type:e.method,success:function(a,b){var c=E(a,e.animation);c&&(e.method=="GET"&&h.cacheGetRequests===!0&&e.$referrer&&e.$referrer.attr("href","#"+c.attr("id")),e.callback&&e.callback(!0))},error:function(a){e.$referrer&&e.$referrer.unselect(),e.callback&&e.callback(!1)}}):e.$referrer&&e.$referrer.unselect()}function H(a){u(),a=a.replace(/^#/,""),window.onhashchange=null,location.hash="#"+a,window.onhashchange=C}function G(){u(),j=Math.abs(window.orientation)==90?"landscape":"portrait",c.removeClass("portrait landscape").addClass(j).trigger("turn",{orientation:j})}function F(a){var b=(new Date).getTime()-m;if(b<p)return!1}function E(b,d){u();var e=null;a(b).each(function(b,d){var f=a(this);f.attr("id")||f.attr("id","page-"+ ++g),a("#"+f.attr("id")).remove(),c.trigger("pageInserted",{page:f.appendTo(c)});if(f.hasClass("current")||!e)e=f});if(e!==null){B(e,d);return e}return!1}function D(b){u(),h=a.extend({},t,b);if(h.preloadImages)for(var c=h.preloadImages.length-1;c>=0;c--)(new Image).src=h.preloadImages[c];if(h.icon||h.icon4){var e,f;h.icon4&&window.devicePixelRatio&&window.devicePixelRatio===2?f=h.icon4:h.icon?f=h.icon:f=!1,f&&(e=h.addGlossToIcon?"":"-precomposed",s+='<link rel="apple-touch-icon'+e+'" href="'+f+'" />')}h.startupScreen&&(s+='<link rel="apple-touch-startup-image" href="'+h.startupScreen+'" />'),h.fixedViewport&&(s+='<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;"/>'),h.fullScreen&&(s+='<meta name="apple-mobile-web-app-capable" content="yes" />',h.statusBar&&(s+='<meta name="apple-mobile-web-app-status-bar-style" content="'+h.statusBar+'" />')),s&&d.prepend(s)}function C(a){u(),f[1]===undefined?u("There is no previous page in history"):location.hash===f[1].hash?A():u(location.hash+" !== "+f[1].hash)}function B(b,c,d){u(),d&&console.warn("The reverse parameter was sent to goTo() function, which is bad.");var e=f[0].page;if(typeof c==="string")for(var g=0,h=r.length;g<h;g++)if(r[g].name===c){c=r[g];break}if(typeof b==="string"){var i=a(b);if(i.length<1){I(b,{animation:c});return}b=i}if(y(e,b,c,d))return o;u("Could not animate pages.");return!1}function A(){u(),f.length<1&&u("History is empty."),f.length===1&&u("You are on the first panel.");var a=f[0],b=f[1];if(y(a.page,b.page,a.animation,!0))return o;u("Could not go back.");return!1}function z(){u();return j}function y(b,c,d,e){function j(l){u(),a.support.animationEvents&&d&&h.useAnimations?(b.unbind("webkitAnimationEnd",j),b.removeClass(g+" out current"),c.removeClass(g+" in")):b.removeClass(g+" out current"),i=c,e?f.shift():w(i,d),b.unselect(),m=(new Date).getTime(),H(i.attr("id")),k=!0,c.trigger("pageAnimationEnd",{direction:"in",animation:d}),b.trigger("pageAnimationEnd",{direction:"out",animation:d})}u();if(c.length===0){a.fn.unselect(),u("Target element is missing.");return!1}if(c.hasClass("current")){a.fn.unselect(),u("You are already on the page you are trying to navigate to.");return!1}a(":focus").blur(),b.trigger("pageAnimationStart",{direction:"out"}),c.trigger("pageAnimationStart",{direction:"in"});if(a.support.animationEvents&&d&&h.useAnimations){k=!1,!a.support.transform3d&&d.is3d&&(d.name=h.fallback2dAnimation);var g;e?d.name.indexOf("left")>0?g=d.name.replace(/left/,"right"):d.name.indexOf("right")>0?g=d.name.replace(/right/,"left"):d.name.indexOf("up")>0?g=d.name.replace(/up/,"down"):d.name.indexOf("down")>0?g=d.name.replace(/down/,"up"):g=d.name:g=d.name,b.bind("webkitAnimationEnd",j),c.addClass(g+" in current"),b.addClass(g+" out")}else c.addClass("current"),j();return!0}function x(b){u();if(!k){u("ClickHandler handler aborted because tap is not ready"),b.preventDefault();return!1}var c=a(b.target);if(!c.is(n.join(", ")))var c=a(b.target).closest(n.join(", "));c&&c.attr("href")&&!c.isExternalLink()?(u("Need to prevent default click behavior"),b.preventDefault()):u("No need to prevent default click behavior"),a.support.touch?u("Not converting click to a tap event because touch handler is on the job"):(u("Converting click event to a tap event"),a(b.target).trigger("tap",b))}function w(a,b,c){u(),f.unshift({page:a,animation:b,hash:"#"+a.attr("id"),id:a.attr("id")})}function v(a){u(),typeof a.selector==="string"&&typeof a.name==="string"&&r.push(a)}function u(a){now=(new Date).getTime(),delta=now-l,l=now,h.debug&&(a?console.log(delta+": "+a):console.log(delta+": Called "+arguments.callee.caller.name))}var c,d=a("head"),e="",f=[],g=0,h={},i="",j="portrait",k=!0,l=0,m=0,n=[],o={},p=351,q=a.jQTouch.prototype.extensions,r=[],s="",t={addGlossToIcon:!0,backSelector:".back, .cancel, .goback",cacheGetRequests:!0,debug:!1,fallback2dAnimation:"fade",fixedViewport:!0,formSelector:"form",fullScreen:!0,fullScreenClass:"fullscreen",hoverDelay:50,icon:null,icon4:null,moveThreshold:10,preloadImages:!1,pressDelay:1e3,startupScreen:null,statusBar:"default",submitSelector:".submit",touchSelector:"a, .touch",useAnimations:!0,useFastTouch:!0,animations:[{selector:".cube",name:"cubeleft",is3d:!0},{selector:".cubeleft",name:"cubeleft",is3d:!0},{selector:".cuberight",name:"cuberight",is3d:!0},{selector:".dissolve",name:"fade",is3d:!1},{selector:".fade",name:"fade",is3d:!1},{selector:".flip",name:"flipleft",is3d:!0},{selector:".flipleft",name:"flipleft",is3d:!0},{selector:".flipright",name:"flipright",is3d:!0},{selector:".pop",name:"pop",is3d:!0},{selector:".slide",name:"slideleft",is3d:!1},{selector:".slidedown",name:"slidedown",is3d:!1},{selector:".slideleft",name:"slideleft",is3d:!1},{selector:".slideright",name:"slideright",is3d:!1},{selector:".slideup",name:"slideup",is3d:!1},{selector:".swap",name:"swapleft",is3d:!0},{selector:"#jqt > * > ul li a",name:"slideleft",is3d:!1}]};D(b),a(document).ready(function(){a.support.animationEvents=L(),a.support.cssMatrix=M(),a.support.touch=N(),a.support.transform3d=O(),a.support.touch||console.warn("This device does not support touch interaction, or it has been deactivated by the developer. Some features might be unavailable."),a.support.transform3d||console.warn("This device does not support 3d animation. 2d animations will be used instead."),a.fn.isExternalLink=function(){var b=a(this);return b.attr("target")=="_blank"||b.attr("rel")=="external"||b.is('a[href^="http://maps.google.com"], a[href^="mailto:"], a[href^="tel:"], a[href^="javascript:"], a[href*="youtube.com/v"], a[href*="youtube.com/watch"]')},a.fn.makeActive=function(){return a(this).addClass("active")},a.fn.press=function(b){return a.isFunction(b)?a(this).live("press",b):a(this).trigger("press")},a.fn.swipe=function(b){return a.isFunction(b)?a(this).live("swipe",b):a(this).trigger("swipe")},a.fn.tap=function(b){return a.isFunction(b)?a(this).live("tap",b):a(this).trigger("tap")},a.fn.unselect=function(b){b?b.removeClass("active"):a(".active").removeClass("active")};for(var b=0,d=q.length;b<d;b++){var f=q[b];a.isFunction(f)&&a.extend(o,f(o))}h.cubeSelector&&(console.warn("NOTE: cubeSelector has been deprecated. Please use cubeleftSelector instead."),h.cubeleftSelector=h.cubeSelector),h.flipSelector&&(console.warn("NOTE: flipSelector has been deprecated. Please use flipleftSelector instead."),h.flipleftSelector=h.flipSelector),h.slideSelector&&(console.warn("NOTE: slideSelector has been deprecated. Please use slideleftSelector instead."),h.slideleftSelector=h.slideSelector);for(var b=0,d=t.animations.length;b<d;b++){var g=t.animations[b];h[g.name+"Selector"]!==undefined&&(g.selector=h[g.name+"Selector"]),v(g)}n.push("input"),n.push(h.touchSelector),n.push(h.backSelector),n.push(h.submitSelector),a(n.join(", ")).css("-webkit-touch-callout","none"),c=a("#jqt"),c.length===0&&(console.warn('Could not find an element with the id "jqt", so the body id has been set to "jqt". If you are having any problems, wrapping your panels in a div with the id "jqt" might help.'),c=a("body").attr("id","jqt")),a.support.transform3d&&c.addClass("supports3d"),h.fullScreenClass&&window.navigator.standalone==!0&&c.addClass(h.fullScreenClass+" "+h.statusBar),c.bind("touchstart",Q).bind("click",x).bind("mousedown",F).bind("orientationchange",G).bind("submit",J).bind("tap",P).trigger("orientationchange"),location.hash.length&&location.replace(location.href.split("#")[0]),a("#jqt > .current").length==0?i=a("#jqt > *:first"):(i=a("#jqt > .current:first"),a("#jqt > .current").removeClass("current")),a(i).addClass("current"),e=a(i).attr("id"),history.replaceState!==undefined?history.replaceState(null,null,"#"+e):H(e),w(i),scrollTo(0,0)}),o={animations:r,hist:f,settings:h,support:a.support,getOrientation:z,goBack:A,goTo:B,addAnimation:v,submitForm:J};return o},a.jQTouch.prototype.extensions=[],a.jQTouch.addExtension=function(b){a.jQTouch.prototype.extensions.push(b)}})(jQuery)